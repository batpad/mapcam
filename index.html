<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapCam Viewer</title>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        .container {
            display: flex;
            height: 100vh;
        }
        #video-container {
            flex: 1;
            padding: 10px;
        }
        #map {
            flex: 1;
            height: 100%;
        }
        video {
            width: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="video-container">
            <video id="camera-feed" controls>
                <source src="testvideo.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
        <div id="map"></div>
    </div>
    <script>
        // Camera position (Empire State Building as example)
        const CAMERA_POSITION = {
            lat: 18.993864,
            lng: 72.820838,
            height: 10000 // meters (approximately 40 stories)
        };

        // Sample CSV data (frame,timestamp,bearing,tilt,zoom)
        const csvData = `
frame,timestamp,bearing,tilt,zoom
0,0.0,0,45,14.0
30,1.0,12,44,14.1
60,2.0,25,43,14.2
90,3.0,35,42,14.3
120,4.0,42,41,14.4
150,5.0,48,40,14.5
180,6.0,55,41,14.6
210,7.0,65,42,14.7
240,8.0,78,43,14.8
270,9.0,90,44,14.9
300,10.0,98,45,15.0
330,11.0,105,44,15.1
360,12.0,112,43,15.0
390,13.0,120,42,14.9
420,14.0,128,41,14.8
450,15.0,135,40,14.7
480,16.0,142,39,14.6
510,17.0,150,38,14.5
540,18.0,158,37,14.4
570,19.0,165,36,14.3
600,20.0,172,35,14.2
630,21.0,180,34,14.1
660,22.0,188,35,14.0
690,23.0,195,36,14.1
720,24.0,202,37,14.2
750,25.0,210,38,14.3
780,26.0,218,39,14.4
810,27.0,225,40,14.5
840,28.0,232,41,14.6
870,29.0,240,42,14.7
900,30.0,248,43,14.8
930,31.0,255,44,14.9
960,32.0,262,45,15.0
990,33.0,270,44,15.1
1020,34.0,278,43,15.0
1050,35.0,285,42,14.9
1080,36.0,292,41,14.8
1110,37.0,300,40,14.7
1140,38.0,308,39,14.6
1170,39.0,315,38,14.5
1200,40.0,322,37,14.4
1230,41.0,330,36,14.3
1260,42.0,338,35,14.2
1290,43.0,345,34,14.1
1320,44.0,352,35,14.0
1350,45.0,358,36,14.1
1380,46.0,360,37,14.2
1410,47.0,5,38,14.3
1440,48.0,12,39,14.4
1470,49.0,18,40,14.5
1500,50.0,25,41,14.6
1530,51.0,32,42,14.7
1560,52.0,40,43,14.8
1590,53.0,48,44,14.9
1620,54.0,55,45,15.0
1650,55.0,62,44,15.1
1680,56.0,70,43,15.0
1710,57.0,78,42,14.9
1740,58.0,85,41,14.8
1770,59.0,92,40,14.7
1800,60.0,100,39,14.6
1830,61.0,108,38,14.5
1860,62.0,115,37,14.4
1890,63.0,122,36,14.3
1920,64.0,130,35,14.2
`;

        // Parse CSV data
        const frameData = csvData.trim().split('\n')
            .slice(1) // Skip header
            .map(line => {
                const [frame, timestamp, bearing, tilt, zoom] = line.split(',');
                return {
                    frame: parseInt(frame),
                    timestamp: parseFloat(timestamp),
                    bearing: parseFloat(bearing),
                    tilt: parseFloat(tilt),
                    zoom: parseFloat(zoom)
                };
            });

        // MapTiler API token - replace with your token from https://cloud.maptiler.com/account/keys/
        const MAPTILER_KEY = 'GqScGKFa73cKg05UxaRX';

        // Initialize map with camera perspective
        const map = new maplibregl.Map({
            container: 'map',
            style: `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
            center: [CAMERA_POSITION.lng, CAMERA_POSITION.lat],
            zoom: 15,
            pitch: 60,
            bearing: 0,
            antialias: true
        });

        map.on('load', () => {
            // Add terrain source
            map.addSource('terrain', {
                'type': 'raster-dem',
                'url': `https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=${MAPTILER_KEY}`,
                'tileSize': 512,
                'maxzoom': 14
            });
            map.setTerrain({ 'source': 'terrain', 'exaggeration': 1.5 });

            // Add 3D buildings
            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'type': 'fill-extrusion',
                'minzoom': 13,
                'paint': {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'height']
                    ],
                    'fill-extrusion-base': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        15,
                        0,
                        15.05,
                        ['get', 'min_height']
                    ],
                    'fill-extrusion-opacity': 0.8
                }
            });
        });

        // Update video playback handler for perspective view
        const video = document.getElementById('camera-feed');
        
        video.addEventListener('timeupdate', () => {
            const currentTime = video.currentTime;
            const currentFrame = frameData.find(frame => 
                frame.timestamp >= currentTime
            ) || frameData[frameData.length - 1];

            // Calculate the point the camera is looking at based on bearing and tilt
            const targetDistance = 1500; // meters - adjust based on your needs
            const bearingRad = currentFrame.bearing * Math.PI / 180;
            const tiltRad = currentFrame.tilt * Math.PI / 180;
            
            // Calculate target point
            const targetPoint = {
                lng: CAMERA_POSITION.lng + (targetDistance * Math.sin(bearingRad) / (111320 * Math.cos(CAMERA_POSITION.lat * Math.PI / 180))),
                lat: CAMERA_POSITION.lat + (targetDistance * Math.cos(bearingRad) / 111320)
            };

            // Update map view
            map.easeTo({
                center: [targetPoint.lng, targetPoint.lat],
                zoom: currentFrame.zoom,
                pitch: 60,
                bearing: currentFrame.bearing,
                duration: 0
            });
        });
    </script>
</body>
</html> 